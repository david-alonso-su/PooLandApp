@page "/report"
@using AspNetMonsters.Blazor.Geolocation;
@using Texnomic.Blazor.hCaptcha
@inject IJSRuntime JsRuntime
@inject ILogger<Report> Logger;
@inject LocationService LocationService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject IDbContextFactory<PooLandDbContext> DbFactory
@inject IOptionsMonitor<PhotoOptions> photoOptions

@if (!IsFormSubmiting && !IsFormSubmited)
{
    <BSContainer Container="Container.Fluid">
        <RadzenTemplateForm Data="@data" Submit="@((FormData args) => { SubmitForm(args); })">

            <RadzenFieldset Text="Poo Data">
                <BSRow MarginBottom="Margins.ExtraSmall" Justify="Justify.Start">
                    <BSCol Column="4" Align="Align.Center">
                        <RadzenLabel Text="Description" />
                    </BSCol>
                    <BSCol Column="8">
                        <RadzenTextBox Name="Description" @bind-Value="data.Description" Style="width:100%; display: block" />
                    </BSCol>
                </BSRow>
                <BSRow MarginBottom="Margins.Large" Align="Align.Center" Justify="Justify.Start">
                    <BSCol Column="2" Align="Align.Center">
                        <RadzenLabel Text="Location" />
                    </BSCol>
                    <BSCol Column="4" >
                        <RadzenTextBox Name="Latitude" @bind-Value="data.strLatitude" Disabled="true" Style="width:100%; display: block" />
                        <RadzenRequiredValidator Component="Latitude" Text="Latitude required" Popup=true Style="position: absolute" />
                    </BSCol>
                    <BSCol Column="4">
                        <RadzenTextBox Name="Longitude" @bind-Value="data.strLongitude" Disabled="true" Style="width:100%; display: block" />
                        <RadzenRequiredValidator Component="Longitude" Text="Longitude required" Popup=true Style="position: absolute" />
                    </BSCol>
                    <BSColBreak />
                    <BSCol Column="2" >
                        <RadzenButton ButtonStyle="ButtonStyle.Info" Icon="add_location" style="margin-left: 11px; width: 166.046875px;" Text="Change Location" Click=@ChangePosition />
                    </BSCol>
                </BSRow>
                <BSRow PaddingLeftAndRight="Padding.Small" Align="Align.Start">
                    <BSCol ColumnLarge="6" OffsetLarge="3" Padding="Padding.Small">
                        <RadzenCard>
                            <RadzenLabel Text="Photo" />
                            <RadzenFileInput @bind-Value=@data.Photo TValue="string" Class="w-100"
                                         Change=@(args => OnChangePhoto(args, "FileInput")) Error=@(args => OnErrorPhoto(args, "FileInput"))
                                         MaxFileSize=@(photoOptions.CurrentValue.MaxFileSize) MaxWidth=@(photoOptions.CurrentValue.MaxWidth) MaxHeight=@(photoOptions.CurrentValue.MaxHeight) />
                        </RadzenCard>
                    </BSCol>
                </BSRow>
                <BSRow PaddingLeftAndRight="Padding.Small" Align="Align.Start">
                    <BSCol ColumnLarge="6" OffsetLarge="3" Padding="Padding.Small">
                        <RadzenCard>
                            <HCaptcha Callback=hCaptchaCallback />
                            <RadzenNumeric Name="HCaptcha" @bind-Value="data.IsCaptchaValid" Visible="false" />
                            <RadzenNumericRangeValidator Min="1" Max="1" Component="HCaptcha" Text="HCaptcha required" Popup=true Style="position: absolute" />
                        </RadzenCard>
                    </BSCol>
                </BSRow>
                <BSRow Justify="Justify.Center" MarginTop="Margins.Medium">
                    <BSCol ColumnMedium="12" Align="Align.End" Class="text-center">
                        <RadzenButton ButtonType="ButtonType.Submit" Icon="save" Text="Send" />
                    </BSCol>
                </BSRow>
            </RadzenFieldset>
        </RadzenTemplateForm>
    </BSContainer>

}
else if (IsFormSubmiting && !IsFormSubmited)
{
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else if (!IsFormSubmiting && IsFormSubmited)
{
    <BSContainer Container="Container.Fluid">
        <BSRow>
            <BSCol>
                <RadzenCard>
                    @if (!IsFormSubmitedError)
                    {
                        <RadzenIcon Icon="check" IconStyle=IconStyle.Success />
                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Poo Uploaded" />
                        <RadzenLink Path="mapview" Text="Go to Map page" />
                    }
                    else
                    {
                        <RadzenIcon Icon="error" IconStyle=IconStyle.Danger />
                        <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Sorry something went wrong" />
                        <RadzenLink Path="report" Text="Try it again" />
                    }
                </RadzenCard>
            </BSCol>
        </BSRow>
    </BSContainer>
}




@code {
    bool IsFormSubmiting = false;
    bool IsFormSubmited = false;
    bool IsFormSubmitedError = false;
    FormData data = new FormData();

    private bool IsCaptchaValid { get; set; }

    protected void hCaptchaCallback(bool Result)
    {
        IsCaptchaValid = Result;
        data.IsCaptchaValid = Convert.ToInt16(IsCaptchaValid);
    }

    protected override async Task OnInitializedAsync()
    {
        await GetLocation();
    }

    async Task SubmitForm(FormData arg)
    {
        IsFormSubmiting = true;
        if (arg.Latitude == 0 || arg.Longitude == 0)
        {
            var message = new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Invalid Coordinates", Detail = "Invalid Coordinates" };
            NotificationService.Notify(message);
            return;
        }

        if (arg.IsCaptchaValid == 0)
        {
            var message = new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Invalid Captcha", Detail = "Invalid Captcha" };
            NotificationService.Notify(message);
            return;
        }

        var poo = new Poodatum
            {
                Date = DateTime.UtcNow,
                Description = arg.Description,
                Location = new NetTopologySuite.Geometries.Point(arg.Latitude,  arg.Longitude),
                Photo = arg.Photo,
                Visible = true
            };

        try
        {
            using var pooContext = DbFactory.CreateDbContext();
            await pooContext.AddAsync(poo);
            await pooContext.SaveChangesAsync();
        }
        catch (Exception ex)
        {

            IsFormSubmitedError = true;
            Logger.LogError(ex.ToString());
        }
        finally
        {
            IsFormSubmiting = false;
            IsFormSubmited = true;
            await InvokeAsync(() => StateHasChanged());
            IsFormSubmited = true;
        }
    }

    public class WindowDimension
    {
        public int Width { get; set; }
        public int Height { get; set; }
    }

    public async Task ChangePosition()
    {
        var dimension = await JsRuntime.InvokeAsync<WindowDimension>("getWindowDimensions");
        var height = dimension.Height - 56;
        var width = dimension.Width - 250;
        
        var result = await DialogService.OpenAsync<MapLocation>("Pick poo location",
               new Dictionary<string, object>() { { "Coordinates", new LatLng(data.Latitude, data.Longitude) } },
               new DialogOptions() { Width = $"{width}px", Height = $"{height}px", Resizable = true, Draggable = true  });

        if (result == null)
        {
            await GetLocation();
        }
        else
        {
            data.Latitude = ((LatLng)result).Lat;
            data.Longitude = ((LatLng)result).Lng;
        }
        await InvokeAsync(() => StateHasChanged());
    }

    async Task GetLocation()
    {
        var location = await LocationService.GetLocationAsync();
        data.Latitude = (float)location.Latitude;
        data.Longitude = (float)location.Longitude;
    }

    void OnChangePhoto(string value, string name)
    {
        Logger.LogDebug($"{name} {value} changed");
    }

    void OnErrorPhoto(UploadErrorEventArgs args, string name)
    {
        Logger.LogError($"{args.Message}");
        var message = new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error Uploading Photo", Detail = args.Message };
        NotificationService.Notify(message);
    }
}
